# -*- coding: utf-8 -*-
import time
import io
import binascii
import threading

import schedule
from pystray import Icon, Menu, MenuItem
from PIL import Image
from win32gui import EnumWindows, GetClassName
from SwitchBot import SwitchBot

NAME = 'Do Not Disturb detector'
WNDCLASSNAMES = [
    'SQEX.CDev.Engine.Framework.MainWindow',
    'Qt663QWindowIcon',         # OBS Studio
]
deviceID = '806599370E22'


class DQX:
    def __init__(self):
        self.running = False
        self.existing = False
        self.paused = False
        self.switchbot = SwitchBot()
        # API access count
        self.count = 0

        self.on_image = Image.open(io.BytesIO(binascii.unhexlify(ON.replace('\n', '').strip())))
        self.off_image = Image.open(io.BytesIO(binascii.unhexlify(OFF.replace('\n', '').strip())))
        self.stop_image = Image.open(io.BytesIO(binascii.unhexlify(STOP.replace('\n', '').strip())))
        menu = Menu(
            MenuItem('Pause', self.pauseApp, checked=lambda _: self.paused),
            Menu.SEPARATOR,
            MenuItem('Exit', self.stopApp),
        )
        self.app = Icon(name=NAME, title=NAME, icon=self.off_image, menu=menu)
        self.detect()

    def detect(self):
        if self.paused:
            print('paused')
            return

        self.proc = None

        def EnumWindowsProc(hWnd):
            for WNDCLASSNAME in WNDCLASSNAMES:
                if GetClassName(hWnd) == WNDCLASSNAME:
                    self.proc = hWnd
                    break

        EnumWindows(lambda hWnd, _: EnumWindowsProc(hWnd), None)

        if self.proc is None:
            if self.existing:
                self.switchbot.set_device_power(deviceID, 'off')
                self.count = self.count + 1
                self.existing = False
                self.app.icon = self.off_image
                print('not running, turn off plug', self.count)
        else:
            if not self.existing:
                self.switchbot.set_device_power(deviceID, 'on')
                self.count = self.count + 1
                self.existing = True
                self.app.icon = self.on_image
                print('running, turn on plug', self.count)
        self.app.update_menu()

    def pauseApp(self):
        self.paused = not self.paused
        if self.paused:
            self.app.icon = self.stop_image
        else:
            if self.existing:
                self.app.icon = self.on_image
            else:
                self.app.icon = self.off_image

        self.app.update_menu()

    def runSchedule(self):
        # SwitchBot API rate limit: 10000 times per day
        # https://github.com/OpenWonderLabs/SwitchBotAPI/blob/main/README.md#request-limit
        # 86400 / 60 -> 1440
        schedule.every(60).seconds.do(self.detect)

        while self.running:
            schedule.run_pending()
            time.sleep(1)

    def stopApp(self):
        self.running = False
        self.app.stop()

    def runApp(self):
        self.running = True

        task_thread = threading.Thread(target=self.runSchedule)
        task_thread.start()

        self.app.run()


ON = """
89504e470d0a1a0a0000000d4948445200000010000000100803000000282d0f530000000467414d410000b18f0bfc6105000000206348524d00007a
26000080840000fa00000080e8000075300000ea6000003a98000017709cba513c00000183504c5445ffff00fefe00fdfd01f3f211eaee26e5f024e5
f025e7f025e9f025e8ef24eaef24ecef24e9f126e9ee24e6f025e4ee23e5f023eaee25f4f310a4a74a3720356d1e276b1e29581f29461e274e202947
252e35242c491a2445252d601e2970283369222a362136adb048999a3c6a1220f5bcb7e0787ad2474bbb4d4ecb5b5b8d2223791819c56667a32729de
6d6ee99393ed9895671624a2a33c9e8b2ead7080fc8c8ef19499fac7c8fcdbdafbc2c4d72f3ae58083ffdddbec686df5a6aaf7c1c0ffd0cc832538a2
a0389c9133984152ffd2ccf8a7a7f39294f7afaefdded9e92a36f7a5a8f48b8ff9a8aaf6999af5a3a4ffa7a5802134a2a1389ca04536000a96383880
23257c101379101288191d73090e87191c7d03049d2227a120258c181b8217154e0e1fa3a33fb7b74152556c554c5755515e53546052535f54505d54
515d575b66584e5b574e5a58546055545e515067bfbf3ef7f706dddc20dbdd23dbdc22dcdc22dbdb21dadc21dbda20dbdb22dcdb21dadc22dbdc23dd
dd20f9f904ffffffc2ad91bd00000001624b47448065bd9e680000000774494d4507e80a0d130011fac9cee8000000a34944415418d3636020081899
500023a60a66165636760e4e2e6e1e5e3e7e01412106611151317109492969195939790545250665155535750d4d2d6d1d5d3d7d0343230663135333
730b4b2b6b1b5b3b7b0747270667175737770f4f2f6f1f5f3fff80c02086e090d0b0f088c8a8e898d8b8f884c42486e494d4b4f48cccf4acec9cdcbc
fc824286a2e292d2b2f28acaaaea9a9ad2daba7a0654a7313212e174740000eaab2155766a23650000002574455874646174653a6372656174650032
3032342d31302d31335431303a30303a32322b30393a3030ae8909ad0000002574455874646174653a6d6f6469667900323032342d31302d31335431
303a30303a31372b30393a3030036399550000000049454e44ae426082
"""

OFF = """
89504e470d0a1a0a0000000d4948445200000010000000100803000000282d0f53000000206348524d00007a26000080840000fa00000080e8000075
300000ea6000003a98000017709cba513c00000132504c54450000008d8d8d8484848181828282838383838484848282838282828181818080808282
828484858b8b8b6e6e6e3030302929292828282727272828282a2a2b29292a3232327070705e5e5e6363645d5d5d6464646060606564656363636767
677878785f5f605c5c5c5c5c5d5b5b5b5b5b5c5b5b5c5a5a5b5b5b5b5c5c5d6161627a7a7a7777787474757373747272737070717070717070717171
72717172727273747475777778151517282b2f1f222514161815171917181b08090a09090a1a1c1f0d0e0f1b1d2026292d23262a1516172527292427
2b2a2d312e3236363a3f2f32370f101221232733373c1e2023292c3032363b2f333818191a1c1e202e313632353b0e0f1125282c2325291818191414
141313151011110d0d0e0c0c0d1010110a0a0a0909090e0f100c0d0d000000c8a034a00000003874524e53002c46464646454545464546472aa6fbf8
f8f8f9f8f8fb9baca1aba2aca2aca18bf8f9f8f8f9f8f9f9f9f680154246444546474546464112bb504e6b00000001624b47440088051d4800000007
74494d4507e80a0d12342f81404a830000006a744558745261772070726f66696c6520747970652061707031000a617070310a20202020202033340a
343934393261303030383030303030303031303033313031303230303037303030303030316130303030303030303030303030303437366636663637
36633635303030300aa75f8a99000000954944415418d36360a0026064626661656363e76065e5e4e2e6e165e0e31710141414101412161614111513
6790b0b0b4b2b6b1b5b37770747276719564907273f7f0f4f2f6f1f5f30f080c0a9666900909f5700f080b8f887476b6748f9265908b8e898d8b4f48
744c4a48484e89926750505452565151555357d150d5d0d4d266d0d1d5d3373034323634343135313533a78657002b5518d20f4db87b000000257445
5874646174653a63726561746500323032342d31302d31335430393a35323a35332b30393a30306d039ce10000002574455874646174653a6d6f6469
667900323032342d31302d31335430393a35323a34372b30393a303024bb00d00000000049454e44ae426082
"""

STOP ="""
89504e470d0a1a0a0000000d4948445200000010000000100803000000282d0f53000000206348524d00007a26000080840000fa00000080e8000075
300000ea6000003a98000017709cba513c0000020a504c5445af85b8a272a9ae84b7ae84b7b288bab187b9b085b8ac81b5b288bab389bbb288bbb289
bbb289bbb188baaf85b8ad83b6b187baaf85b8b187b9b289bbb086b9b085b8af84b8b086b8af85b8b086b9b188bab288bab187b9af85b8af85b8b389
bbb086b9b187b9af85b8b086b9b187b9b187b9b187b9b288bab085b8b187bab289bbb38abcb389bbb38abcb187bab289bbae84b7b187bab187b9b086
b9b086b8b188baaf85b8b085b8b086b9b288bab188bab288bbb086b9b288bbb289bbb38abbb187bab289bbb188bab288bab187b9b389bbaf85b8af85
b8af85b8b086b9b086b9af84b8b187bab187b9b38abcb389bbb187b9b086b9b187b9b187bab389bbb38abcb288bab289bbb188bab288bab389bbb38a
bcb38abcab80b4af84b7b086b9af84b8b389bbb389bbb188baaf84b7af85b8ad82b6b187bab288bab58cbdb188bab086b9b086b8ae84b7b187b9af85
b8b085b8b188bab187bab289bbb288bbb389bcb48abcb288baad83b59a709f996f9eac82b49c73a2926995a67cac5b32565e3559a077a6744b725229
4c805680b38abc572f525b32579d73a270476e4f2749784f77b389bbb48abd9b72a0582f539e74a3714870754c74af84b8b38abb99709e572e515931
54744b73532a4d734a72562d509f75a4774e77532a4c724870a87eae70476fa77dae8a608c663d63845a85b289baaf86b7af85b7ae84b5b087b8b48b
bdb48bbcfffffff61ca3f50000006b74524e5300010c171a1e1e1c1e1d1918161414091baad2d5d9d8d7d9d7d3d2cfcecf8d0932e9dd2339ece52c3a
ede9323ceeea3442f1e83044f2e83144f2ea3443f2ea3444f2e93345f3eb3644f2ee3a45f3ed3931cde4e2e5e7eaecece9e8bc1e031f29282c2f3537
3733342f1801992277e800000001624b4744ad2062c21d0000000774494d4507e80a0f10350c93b116550000006a744558745261772070726f66696c
6520747970652061707031000a617070310a20202020202033340a343934393261303030383030303030303031303033313031303230303037303030
30303031613030303030303030303030303030343736663666363736633635303030300aa75f8a990000011b4944415418d3011001effe0001020304
05060708090a0b0c0d0e0f0000101112131415161718191a1b1c1d1e1f0020216b6c6d6e6b6d6f706e716e7222230024256b6f6b73746e7576747772
6e2627002829747278797a7b7c7d7e7377722a2b002c2d73757c7f80818283848577712e2f00303177747a868788898a8b8c727232330034358c8d8e
8f7f90918a927172933637003839948d9596978898999a6c706b3a3b003c3d778c8e9b869c9d9e9f6e6b6e3e3f0040418c76a09aa1a2a3a4a5a66b73
4243004445857771a7a877a6a9aa768c6b46470048496b6e77858594abac767377774a4b004c4d6e7285768c85abac85718c8c4e4f00505152535455
425657582156595a5b5c005d5e5f6061622063646566672068696a564f606397b950a10000002574455874646174653a63726561746500323032342d
31302d31355430373a35333a31372b30393a30305bb3b8620000002574455874646174653a6d6f6469667900323032342d31302d31355430373a3533
3a31322b30393a303078d62f790000000049454e44ae426082
"""


if __name__ == '__main__':
    DQX().runApp()
